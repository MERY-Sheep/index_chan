<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index-chan - 3Dä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }
        
        #graph-container {
            width: 100vw;
            height: 100vh;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #16213e;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        #info-panel h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #4ecca3;
        }
        
        #info-panel p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        #info-panel .stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #16213e;
        }
        
        #info-panel .stat:last-child {
            border-bottom: none;
        }
        
        #info-panel .label {
            color: #93b5c6;
        }
        
        #info-panel .value {
            color: #4ecca3;
            font-weight: bold;
        }
        
        #node-details {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #16213e;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        #node-details h3 {
            margin: 0 0 15px 0;
            color: #4ecca3;
            font-size: 18px;
        }
        
        #node-details .detail-row {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #16213e;
        }
        
        #node-details .detail-label {
            color: #93b5c6;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        #node-details .detail-value {
            color: #eee;
            font-size: 14px;
            word-break: break-all;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .loading h1 {
            color: #4ecca3;
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        .spinner {
            border: 4px solid #16213e;
            border-top: 4px solid #4ecca3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #16213e;
        }
        
        .controls button {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .controls button:hover {
            background: #3daa82;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <h1>ğŸ” index-chan</h1>
        <div class="spinner"></div>
        <p>ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    
    <div id="graph-container"></div>
    
    <div id="info-panel">
        <h2>ğŸ“Š ã‚°ãƒ©ãƒ•çµ±è¨ˆ</h2>
        <div class="stat">
            <span class="label">ãƒãƒ¼ãƒ‰æ•°:</span>
            <span class="value" id="node-count">-</span>
        </div>
        <div class="stat">
            <span class="label">ã‚¨ãƒƒã‚¸æ•°:</span>
            <span class="value" id="edge-count">-</span>
        </div>
        <div class="stat">
            <span class="label">æœªä½¿ç”¨:</span>
            <span class="value" id="unused-count">-</span>
        </div>
        <p style="margin-top: 15px; font-size: 12px; color: #93b5c6;">
            ğŸ’¡ ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º<br>
            ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢<br>
            ğŸ” ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
        </p>
    </div>
    
    <div id="node-details">
        <h3 id="node-name">-</h3>
        <div class="detail-row">
            <div class="detail-label">ã‚¿ã‚¤ãƒ—</div>
            <div class="detail-value" id="node-type">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">ãƒ•ã‚¡ã‚¤ãƒ«</div>
            <div class="detail-value" id="node-file">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">è¡Œç¯„å›²</div>
            <div class="detail-value" id="node-lines">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
            <div class="detail-value" id="node-exported">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">ä½¿ç”¨çŠ¶æ³</div>
            <div class="detail-value" id="node-used">-</div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="resetCamera()">ğŸ¯ ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="togglePause()">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
    </div>

    <script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>
    
    <script>
        let graph;
        let isPaused = false;
        
        async function loadGraph() {
            try {
                const response = await fetch('/api/graph');
                const data = await response.json();
                
                // Convert to force-graph format
                const nodes = Object.entries(data.nodes).map(([id, node]) => ({
                    id: parseInt(id),
                    name: node.name,
                    type: node.node_type,
                    file: node.file_path,
                    lines: node.line_range,
                    exported: node.is_exported,
                    used: node.is_used,
                    color: node.is_used ? '#4ecca3' : '#e74c3c'
                }));
                
                const links = data.edges
                    .filter(edge => 
                        data.nodes[edge.from] && data.nodes[edge.to]
                    )
                    .map(edge => ({
                        source: edge.from,
                        target: edge.to,
                        type: edge.edge_type
                    }));
                
                // Update stats
                document.getElementById('node-count').textContent = nodes.length;
                document.getElementById('edge-count').textContent = links.length;
                document.getElementById('unused-count').textContent = 
                    nodes.filter(n => !n.used).length;
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Create graph
                graph = ForceGraph3D()
                    (document.getElementById('graph-container'))
                    .graphData({ nodes, links })
                    .nodeLabel('name')
                    .nodeColor('color')
                    .nodeRelSize(6)
                    .linkColor(() => '#93b5c6')
                    .linkOpacity(0.5)
                    .linkWidth(2)
                    .onNodeClick(node => {
                        showNodeDetails(node);
                    })
                    .backgroundColor('#1a1a2e');
                
            } catch (error) {
                console.error('ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                document.getElementById('loading').innerHTML = 
                    '<h1>âŒ ã‚¨ãƒ©ãƒ¼</h1><p>ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }
        
        function showNodeDetails(node) {
            const panel = document.getElementById('node-details');
            panel.style.display = 'block';
            
            document.getElementById('node-name').textContent = node.name;
            document.getElementById('node-type').textContent = node.type;
            document.getElementById('node-file').textContent = node.file;
            document.getElementById('node-lines').textContent = 
                `${node.lines[0]} - ${node.lines[1]}`;
            document.getElementById('node-exported').textContent = 
                node.exported ? 'âœ… ã¯ã„' : 'âŒ ã„ã„ãˆ';
            document.getElementById('node-used').textContent = 
                node.used ? 'âœ… ä½¿ç”¨ä¸­' : 'âš ï¸ æœªä½¿ç”¨';
        }
        
        function resetCamera() {
            if (graph) {
                graph.cameraPosition({ x: 0, y: 0, z: 1000 }, { x: 0, y: 0, z: 0 }, 1000);
            }
        }
        
        function togglePause() {
            isPaused = !isPaused;
            if (graph) {
                if (isPaused) {
                    graph.pauseAnimation();
                    event.target.textContent = 'â–¶ï¸ å†é–‹';
                } else {
                    graph.resumeAnimation();
                    event.target.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                }
            }
        }
        
        // Load graph on page load
        loadGraph();
    </script>
</body>
</html>
