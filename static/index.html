<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index-chan - 3Dä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }
        
        #graph-container {
            width: 100vw;
            height: 100vh;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #16213e;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        #info-panel h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #4ecca3;
        }
        
        #info-panel p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        #info-panel .stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #16213e;
        }
        
        #info-panel .stat:last-child {
            border-bottom: none;
        }
        
        #info-panel .label {
            color: #93b5c6;
        }
        
        #info-panel .value {
            color: #4ecca3;
            font-weight: bold;
        }
        
        #node-details {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #16213e;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        #node-details h3 {
            margin: 0 0 15px 0;
            color: #4ecca3;
            font-size: 18px;
        }
        
        #node-details .detail-row {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #16213e;
        }
        
        #node-details .detail-label {
            color: #93b5c6;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        #node-details .detail-value {
            color: #eee;
            font-size: 14px;
            word-break: break-all;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .loading h1 {
            color: #4ecca3;
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        .spinner {
            border: 4px solid #16213e;
            border-top: 4px solid #4ecca3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #16213e;
        }
        
        .controls button {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .controls button:hover {
            background: #3daa82;
        }
        
        #filter-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 46, 0.95);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #16213e;
            min-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        #filter-panel h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #4ecca3;
        }
        
        .filter-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #filter-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #16213e;
            border-radius: 5px;
            background: #16213e;
            color: #eee;
            font-size: 14px;
        }
        
        #filter-input:focus {
            outline: none;
            border-color: #4ecca3;
        }
        
        .filter-btn {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .filter-btn:hover {
            background: #3daa82;
        }
        
        .filter-btn.secondary {
            background: #93b5c6;
        }
        
        .filter-btn.secondary:hover {
            background: #7a9aaa;
        }
        
        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-filter-btn {
            background: #16213e;
            color: #93b5c6;
            border: 1px solid #93b5c6;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .quick-filter-btn:hover {
            background: #93b5c6;
            color: #1a1a2e;
        }
        
        #filter-stats {
            margin-top: 15px;
            padding: 10px;
            background: #16213e;
            border-radius: 5px;
            font-size: 13px;
            display: none;
        }
        
        #filter-stats .stat-line {
            margin: 5px 0;
        }
        
        #filter-stats .highlight {
            color: #4ecca3;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <h1>ğŸ” index-chan</h1>
        <div class="spinner"></div>
        <p>ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    
    <div id="graph-container"></div>
    
    <div id="filter-panel">
        <h2>ğŸ” ã‚°ãƒ©ãƒ•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
        <div class="filter-input-group">
            <input type="text" id="filter-input" placeholder="ä¾‹: LLMé–¢é€£ã€scanner.rsã€ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰">
            <button class="filter-btn" onclick="applyFilter()">é©ç”¨</button>
            <button class="filter-btn secondary" onclick="clearFilter()">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="quick-filters">
            <button class="quick-filter-btn" onclick="quickFilter('dead-code')">ğŸ—‘ï¸ ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰ã®ã¿</button>
            <button class="quick-filter-btn" onclick="quickFilter('llm')">ğŸ¤– LLMé–¢é€£</button>
            <button class="quick-filter-btn" onclick="quickFilter('scanner')">ğŸ“‚ Scanneré–¢é€£</button>
            <button class="quick-filter-btn" onclick="quickFilter('database')">ğŸ’¾ Databaseé–¢é€£</button>
        </div>
        <div id="filter-stats">
            <div class="stat-line">
                ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: <span class="highlight" id="filter-query">-</span>
            </div>
            <div class="stat-line">
                è¡¨ç¤ºä¸­: <span class="highlight" id="filtered-nodes">-</span> ãƒãƒ¼ãƒ‰ / 
                <span class="highlight" id="filtered-edges">-</span> ã‚¨ãƒƒã‚¸
                ï¼ˆå…¨ä½“: <span id="total-nodes">-</span> / <span id="total-edges">-</span>ï¼‰
            </div>
        </div>
    </div>
    
    <div id="info-panel">
        <h2>ğŸ“Š ã‚°ãƒ©ãƒ•çµ±è¨ˆ</h2>
        <div class="stat">
            <span class="label">ãƒãƒ¼ãƒ‰æ•°:</span>
            <span class="value" id="node-count">-</span>
        </div>
        <div class="stat">
            <span class="label">ã‚¨ãƒƒã‚¸æ•°:</span>
            <span class="value" id="edge-count">-</span>
        </div>
        <div class="stat">
            <span class="label">æœªä½¿ç”¨:</span>
            <span class="value" id="unused-count">-</span>
        </div>
        <p style="margin-top: 15px; font-size: 12px; color: #93b5c6;">
            ğŸ’¡ ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º<br>
            ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢<br>
            ğŸ” ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
        </p>
    </div>
    
    <div id="node-details">
        <h3 id="node-name">-</h3>
        <div class="detail-row">
            <div class="detail-label">ã‚¿ã‚¤ãƒ—</div>
            <div class="detail-value" id="node-type">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">ãƒ•ã‚¡ã‚¤ãƒ«</div>
            <div class="detail-value" id="node-file">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">è¡Œç¯„å›²</div>
            <div class="detail-value" id="node-lines">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
            <div class="detail-value" id="node-exported">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">ä½¿ç”¨çŠ¶æ³</div>
            <div class="detail-value" id="node-used">-</div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="resetCamera()">ğŸ¯ ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="togglePause()">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
    </div>

    <script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>
    
    <script>
        let graph;
        let isPaused = false;
        let originalGraphData = null;
        let currentGraphData = null;
        
        async function loadGraph() {
            try {
                const response = await fetch('/api/graph');
                const data = await response.json();
                
                // Convert to force-graph format
                const nodes = Object.entries(data.nodes).map(([id, node]) => ({
                    id: parseInt(id),
                    name: node.name,
                    type: node.node_type,
                    file: node.file_path,
                    lines: node.line_range,
                    exported: node.is_exported,
                    used: node.is_used,
                    color: node.is_used ? '#4ecca3' : '#e74c3c'
                }));
                
                const links = data.edges
                    .filter(edge => 
                        data.nodes[edge.from] && data.nodes[edge.to]
                    )
                    .map(edge => ({
                        source: edge.from,
                        target: edge.to,
                        type: edge.edge_type
                    }));
                
                // Store original data
                originalGraphData = { nodes, links };
                currentGraphData = { nodes, links };
                
                // Update stats
                updateStats(nodes, links);
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Create graph
                graph = ForceGraph3D()
                    (document.getElementById('graph-container'))
                    .graphData({ nodes, links })
                    .nodeLabel('name')
                    .nodeColor('color')
                    .nodeRelSize(6)
                    .linkColor(() => '#93b5c6')
                    .linkOpacity(0.5)
                    .linkWidth(2)
                    .onNodeClick(node => {
                        showNodeDetails(node);
                    })
                    .backgroundColor('#1a1a2e');
                
            } catch (error) {
                console.error('ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                document.getElementById('loading').innerHTML = 
                    '<h1>âŒ ã‚¨ãƒ©ãƒ¼</h1><p>ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }
        
        function showNodeDetails(node) {
            const panel = document.getElementById('node-details');
            panel.style.display = 'block';
            
            document.getElementById('node-name').textContent = node.name;
            document.getElementById('node-type').textContent = node.type;
            document.getElementById('node-file').textContent = node.file;
            document.getElementById('node-lines').textContent = 
                `${node.lines[0]} - ${node.lines[1]}`;
            document.getElementById('node-exported').textContent = 
                node.exported ? 'âœ… ã¯ã„' : 'âŒ ã„ã„ãˆ';
            document.getElementById('node-used').textContent = 
                node.used ? 'âœ… ä½¿ç”¨ä¸­' : 'âš ï¸ æœªä½¿ç”¨';
        }
        
        function resetCamera() {
            if (graph) {
                graph.cameraPosition({ x: 0, y: 0, z: 1000 }, { x: 0, y: 0, z: 0 }, 1000);
            }
        }
        
        function togglePause() {
            isPaused = !isPaused;
            if (graph) {
                if (isPaused) {
                    graph.pauseAnimation();
                    event.target.textContent = 'â–¶ï¸ å†é–‹';
                } else {
                    graph.resumeAnimation();
                    event.target.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                }
            }
        }
        
        function updateStats(nodes, links) {
            document.getElementById('node-count').textContent = nodes.length;
            document.getElementById('edge-count').textContent = links.length;
            document.getElementById('unused-count').textContent = 
                nodes.filter(n => !n.used).length;
        }
        
        async function applyFilter() {
            const query = document.getElementById('filter-input').value.trim();
            if (!query) {
                alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch('/api/filter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        include_dependencies: true,
                        use_llm: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                applyFilteredGraph(result.graph, result.stats);
                
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        async function quickFilter(type) {
            try {
                let response;
                
                if (type === 'dead-code') {
                    response = await fetch('/api/filter/dead-code');
                } else {
                    // Use keywords filter
                    response = await fetch(`/api/filter/keywords?keywords=${type}&include_dependencies=true`);
                }
                
                if (!response.ok) {
                    throw new Error('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                applyFilteredGraph(result.graph, result.stats);
                
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function applyFilteredGraph(filteredGraph, stats) {
            // Convert to force-graph format
            const nodes = Object.entries(filteredGraph.nodes).map(([id, node]) => ({
                id: parseInt(id),
                name: node.name,
                type: node.node_type,
                file: node.file_path,
                lines: node.line_range,
                exported: node.is_exported,
                used: node.is_used,
                color: node.is_used ? '#4ecca3' : '#e74c3c'
            }));
            
            const links = filteredGraph.edges
                .filter(edge => 
                    filteredGraph.nodes[edge.from] && filteredGraph.nodes[edge.to]
                )
                .map(edge => ({
                    source: edge.from,
                    target: edge.to,
                    type: edge.edge_type
                }));
            
            currentGraphData = { nodes, links };
            
            // Update graph
            if (graph) {
                graph.graphData(currentGraphData);
            }
            
            // Update stats
            updateStats(nodes, links);
            
            // Show filter stats
            const filterStatsPanel = document.getElementById('filter-stats');
            filterStatsPanel.style.display = 'block';
            document.getElementById('filter-query').textContent = stats.filter_query;
            document.getElementById('filtered-nodes').textContent = stats.filtered_nodes;
            document.getElementById('filtered-edges').textContent = stats.filtered_edges;
            document.getElementById('total-nodes').textContent = stats.original_nodes;
            document.getElementById('total-edges').textContent = stats.original_edges;
        }
        
        function clearFilter() {
            if (!originalGraphData) {
                return;
            }
            
            // Restore original graph
            currentGraphData = originalGraphData;
            
            if (graph) {
                graph.graphData(currentGraphData);
            }
            
            // Update stats
            updateStats(currentGraphData.nodes, currentGraphData.links);
            
            // Hide filter stats
            document.getElementById('filter-stats').style.display = 'none';
            document.getElementById('filter-input').value = '';
        }
        
        // Load graph on page load
        loadGraph();
    </script>
</body>
</html>
