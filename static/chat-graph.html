<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index-chan - 会話グラフ</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1b26;
            color: #c0caf5;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .graph-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #414868;
        }

        .prompt-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            background: #16161e;
        }

        .panel-header {
            padding: 16px;
            background: #1f2335;
            border-bottom: 1px solid #414868;
            font-weight: 600;
            font-size: 14px;
        }

        #cy {
            flex: 1;
            background: #1a1b26;
        }

        .prompt-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .prompt-item {
            background: #1f2335;
            border: 1px solid #414868;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-item:hover {
            border-color: #7aa2f7;
            box-shadow: 0 0 10px rgba(122, 162, 247, 0.2);
        }

        .prompt-item.selected {
            border-color: #7aa2f7;
            background: #24283b;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .prompt-id {
            font-weight: 600;
            color: #7aa2f7;
        }

        .prompt-meta {
            font-size: 12px;
            color: #565f89;
        }

        .prompt-body {
            font-size: 13px;
            line-height: 1.6;
        }

        .message-block {
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 4px;
            background: #16161e;
        }

        .message-role {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .message-role.user {
            color: #7dcfff;
        }

        .message-role.assistant {
            color: #9ece6a;
        }

        .message-content {
            color: #c0caf5;
        }

        .token-count {
            display: inline-block;
            background: #414868;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .copy-btn {
            background: #7aa2f7;
            color: #1a1b26;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #89b4fa;
        }

        .stats {
            padding: 12px 16px;
            background: #1f2335;
            border-top: 1px solid #414868;
            font-size: 12px;
            display: flex;
            gap: 16px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #565f89;
        }

        .stat-value {
            color: #7aa2f7;
            font-weight: 600;
        }

        .legend {
            padding: 12px 16px;
            background: #1f2335;
            border-bottom: 1px solid #414868;
            font-size: 11px;
            display: flex;
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.user {
            background: #7dcfff;
        }

        .legend-dot.assistant {
            background: #9ece6a;
        }

        .legend-dot.reduced {
            background: #565f89;
            opacity: 0.5;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #414868;
            border-top: 4px solid #7aa2f7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>会話グラフを読み込み中...</div>
    </div>

    <div class="container" style="display: none;" id="main-container">
        <div class="graph-panel">
            <div class="panel-header">会話グラフ</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot user"></div>
                    <span>ユーザー</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot assistant"></div>
                    <span>アシスタント</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot reduced"></div>
                    <span>削減済み</span>
                </div>
            </div>
            <div id="cy"></div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">総メッセージ数:</span>
                    <span class="stat-value" id="total-messages">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">削減数:</span>
                    <span class="stat-value" id="reduced-messages">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">削減率:</span>
                    <span class="stat-value" id="reduction-rate">0%</span>
                </div>
            </div>
        </div>

        <div class="prompt-panel">
            <div class="panel-header">会話履歴</div>
            <div class="prompt-content" id="prompt-list">
                <!-- 会話履歴がここに表示されます -->
            </div>
        </div>
    </div>

    <script type="module">
        const { invoke } = window.__TAURI__.core;

        let cy = null;
        let graphData = null;

        // Load graph data from Tauri backend
        async function loadGraphData() {
            try {
                // chat_history.jsonのパスを取得（Tauriアプリのディレクトリ）
                const historyPath = 'chat_history.json';
                
                graphData = await invoke('get_conversation_graph', { historyPath });
                console.log('Loaded graph data:', graphData);
                
                initializeGraph();
                renderMessages();
                
                // Hide loading, show main container
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-container').style.display = 'flex';
            } catch (error) {
                console.error('Error loading graph data:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #f7768e;">
                        <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                        <div>エラー: ${error}</div>
                        <div style="margin-top: 16px; font-size: 12px; color: #565f89;">
                            chat_history.jsonが見つかりません
                        </div>
                    </div>
                `;
            }
        }

        // Initialize Cytoscape graph
        function initializeGraph() {
            if (!graphData) return;

            cy = cytoscape({
                container: document.getElementById('cy'),
                
                elements: [
                    // Nodes
                    ...graphData.nodes.map(node => ({
                        data: {
                            id: node.id,
                            label: `${node.role}\n${node.content.substring(0, 20)}...\n${node.timestamp}`,
                            role: node.role,
                            content: node.content,
                            timestamp: node.timestamp,
                            isReduced: node.is_reduced
                        }
                    })),
                    // Edges
                    ...graphData.edges.map(edge => ({
                        data: {
                            source: edge.from,
                            target: edge.to,
                            type: edge.edge_type
                        }
                    }))
                ],

                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': function(ele) {
                                if (ele.data('isReduced')) return '#565f89';
                                return ele.data('role') === 'user' ? '#7dcfff' : '#9ece6a';
                            },
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#c0caf5',
                            'font-size': '10px',
                            'text-wrap': 'wrap',
                            'text-max-width': '100px',
                            'width': 60,
                            'height': 60,
                            'opacity': function(ele) {
                                return ele.data('isReduced') ? 0.5 : 1;
                            }
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 3,
                            'border-color': '#7aa2f7',
                            'background-color': '#7aa2f7'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': function(ele) {
                                return ele.data('type') === 'sequential' ? 2 : 1;
                            },
                            'line-color': function(ele) {
                                return ele.data('type') === 'sequential' ? '#414868' : '#565f89';
                            },
                            'line-style': function(ele) {
                                return ele.data('type') === 'sequential' ? 'solid' : 'dashed';
                            },
                            'target-arrow-color': '#414868',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    }
                ],

                layout: {
                    name: 'breadthfirst',
                    directed: true,
                    spacingFactor: 1.5,
                    animate: true,
                    animationDuration: 500
                }
            });

            // Update statistics
            document.getElementById('total-messages').textContent = graphData.metadata.total_nodes;
            document.getElementById('reduced-messages').textContent = graphData.metadata.reduced_nodes;
            document.getElementById('reduction-rate').textContent = `${graphData.metadata.reduction_rate.toFixed(1)}%`;

            // Node click event
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const nodeId = node.id();
                highlightNode(nodeId);
            });
        }

        // Render messages in the right panel
        function renderMessages() {
            if (!graphData) return;

            const promptList = document.getElementById('prompt-list');
            promptList.innerHTML = '';

            graphData.nodes.forEach(node => {
                const messageBlock = document.createElement('div');
                messageBlock.className = 'message-block';
                messageBlock.dataset.nodeId = node.id;
                messageBlock.innerHTML = `
                    <div class="message-role ${node.role}">${node.role}</div>
                    <div class="message-content">${node.content}</div>
                    <div style="margin-top: 8px; font-size: 11px; color: #565f89;">
                        ${node.timestamp}
                        ${node.is_reduced ? ' • <span style="color: #f7768e;">削減済み</span>' : ''}
                    </div>
                `;
                
                messageBlock.addEventListener('click', () => {
                    highlightNode(node.id);
                });
                
                promptList.appendChild(messageBlock);
            });
        }

        // Highlight specific node
        function highlightNode(nodeId) {
            if (!cy) return;
            
            cy.nodes().unselect();
            const node = cy.getElementById(nodeId);
            node.select();
            cy.animate({
                center: { eles: node },
                zoom: 1.5
            }, {
                duration: 500
            });

            // Scroll to message in right panel
            const messageBlock = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (messageBlock) {
                messageBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageBlock.style.background = '#24283b';
                setTimeout(() => {
                    messageBlock.style.background = '#16161e';
                }, 1000);
            }
        }

        // Initialize on load
        loadGraphData();
    </script>
</body>
</html>
